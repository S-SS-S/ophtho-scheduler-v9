<!doctype html>
<html lang="ar" dir="rtl" class="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ophthalmology Visit Scheduler | حاسبة مواعيد العيون</title>
  <meta name="description" content="Compute the next ophthalmology visit based on condition, age (or age group), and last visit date. Arabic/English." />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: { extend: { fontFamily: { sans: ["Tajawal","system-ui","-apple-system","Segoe UI","Roboto","Arial"] } } }
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet" />
  <style>
    html { scroll-behavior: smooth; }
    .error-text { color: #dc2626; font-size: 12px; margin-top: .25rem }
    .invalid { outline: 0; box-shadow: 0 0 0 4px rgba(244,63,94,.25); border-color:#ef4444 }
    @media print { html{color-scheme:light} body{background:#fff!important} .no-print{display:none!important} }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 via-cyan-50 to-indigo-50 text-slate-800 dark:from-slate-900 dark:via-slate-900 dark:to-slate-900 dark:text-slate-100">
  <header class="max-w-5xl mx-auto px-4 pt-8">
    <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
      <h1 id="title" class="text-2xl md:text-3xl font-bold">حاسبة مواعيد زيارة طبيب العيون</h1>
      <div class="flex flex-wrap items-center gap-2">
        <div class="inline-flex items-center gap-2 rounded-full px-3 py-1 text-sm border border-slate-300 bg-white dark:bg-slate-800 dark:border-slate-600">
          <button id="lang-ar" class="font-medium">العربية</button>
          <span class="mx-1">|</span>
          <button id="lang-en">English</button>
        </div>
        <div class="inline-flex items-center gap-2 rounded-full px-3 py-1 text-sm border border-slate-300 bg-white dark:bg-slate-800 dark:border-slate-600" title="Theme">
          <button id="theme-light" class="font-medium">Light</button>
          <span class="mx-1">/</span>
          <button id="theme-dark">Dark</button>
        </div>
      </div>
    </div>
    <p id="subtitle" class="mt-2 text-slate-600 dark:text-slate-300">اختر الحالات، أدخل عمرك أو فئتك العمرية وتاريخ آخر زيارة، وسنحسب أقرب موعد.</p>
  </header>

  <main class="max-w-5xl mx-auto px-4 py-6">
    <!-- CONTACT BOX -->
    <div class="mb-4">
      <details class="bg-white/80 dark:bg-slate-900/70 backdrop-blur shadow-lg rounded-2xl border border-gray-200 dark:border-slate-700 p-4 w-full sm:w-auto sm:min-w-[260px] ml-auto">
        <summary id="contactSummary" class="cursor-pointer select-none text-sm font-medium flex items-center justify-between">
          تواصل <span aria-hidden="true">▾</span>
        </summary>
        <div class="mt-3 text-sm space-y-1">
          <div><span id="contactEmailLabel">البريد الإلكتروني</span>:
            <a href="mailto:Sultan.Alhassan@hotmail.com" class="underline break-all" dir="ltr">Sultan.Alhassan@hotmail.com</a>
          </div>
          <div><span id="contactPhoneLabel">الهاتف</span>:
            <a href="tel:+966564215644" class="underline" dir="ltr">+966564215644</a>
          </div>
        </div>
      </details>
    </div>
    <!-- END CONTACT BOX -->

    <section class="bg-white/80 dark:bg-slate-900/70 backdrop-blur shadow-lg rounded-2xl border border-gray-200 dark:border-slate-700 p-5 md:p-6">
      <form id="schedulerForm" class="space-y-6" novalidate>
        <div class="grid md:grid-cols-2 gap-4">
          <div class="space-y-3">
            <div class="flex items-center gap-2">
              <input id="ageGroupToggle" type="checkbox" class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" />
              <label for="ageGroupToggle" id="lblAgeGroupToggle" class="text-sm">استخدام الفئة العمرية بدلاً من تاريخ الميلاد</label>
            </div>
            <div id="dobWrap" class="space-y-2">
              <label for="dob" id="lblDob" class="block text-sm font-medium">تاريخ الميلاد</label>
              <input id="dob" name="dob" type="date" class="w-full rounded-2xl border-2 border-slate-300/90 bg-white dark:bg-slate-800 h-12 text-base px-4 focus:outline-none focus:ring-4 focus:ring-indigo-200 dark:focus:ring-indigo-900 focus:border-indigo-600" />
              <p id="helpDob" class="text-xs text-slate-500">يُستخدم لحساب الفئة العمرية.</p>
              <p id="dobError" class="error-text hidden" aria-live="polite"></p>
            </div>
            <div id="ageGroupWrap" class="space-y-2 hidden">
              <label for="ageGroup" id="lblAgeGroup" class="block text-sm font-medium">الفئة العمرية</label>
              <select id="ageGroup" class="w-full rounded-2xl border-2 border-slate-300/90 dark:border-slate-600 bg-white dark:bg-slate-800 h-12 text-base px-4 focus:outline-none focus:ring-4 focus:ring-indigo-200 dark:focus:ring-indigo-900 focus:border-indigo-600">
                <option value="u40">&lt; 40</option>
                <option value="40-54">40–54</option>
                <option value="55-64">55–64</option>
                <option value=">=65">≥65</option>
              </select>
              <p id="helpAgeGroup" class="text-xs text-slate-500">اختر فقط إذا لم ترغب بإدخال تاريخ الميلاد.</p>
            </div>
          </div>

          <!-- Last visit + No-visit option -->
          <div class="space-y-2" id="lastVisitWrap">
            <label for="lastVisit" class="block text-sm font-medium">
              <span id="lblLastVisit">تاريخ آخر زيارة لطبيب العيون</span> <span class="text-rose-600" aria-hidden="true">*</span>
            </label>
            <input id="lastVisit" name="lastVisit" type="date" required
                   class="w-full rounded-2xl border-2 border-slate-300/90 dark:border-slate-600 bg-white dark:bg-slate-800 h-12 text-base px-4 focus:outline-none focus:ring-4 focus:ring-indigo-200 dark:focus:ring-indigo-900 focus:border-indigo-600" aria-describedby="lastVisitHelp lastVisitError" />
            <label class="inline-flex items-center gap-2 text-sm mt-1">
              <input id="noOphthVisit" type="checkbox" class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" />
              <span id="lblNoOphthVisit">لا توجد لدي زيارات سابقة لطبيب العيون</span>
            </label>
            <p id="helpLastVisit" class="text-xs text-slate-500">مثال: 2024-12-05. لا تقبل تاريخًا مستقبليًا.</p>
            <p id="lastVisitError" class="error-text hidden" aria-live="polite"></p>
          </div>
        </div>

        <!-- Conditions selectable list -->
        <div>
          <h2 id="condHeader" class="text-lg font-semibold mb-2">اختر الحالات/الظروف لديك</h2>
          <p id="condHelper" class="text-sm text-slate-600 dark:text-slate-300 mb-3">يمكنك اختيار أكثر من حالة؛ سنعرض أقرب موعد.</p>

          <div id="condMultiRoot" class="relative">
            <div id="condControl" class="flex flex-wrap items-center gap-2 p-2 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 cursor-text">
              <div id="selectedChips" class="flex flex-wrap gap-2"></div>
              <input id="condSearch" type="text" class="flex-1 min-w-[10ch] bg-transparent outline-none text-sm placeholder-slate-400 dark:placeholder-slate-500" placeholder="ابحث عن الحالة..." />
              <button id="clearConds" type="button" class="text-xs text-slate-500 hover:underline hidden">مسح</button>
            </div>
            <div id="condDropdown" class="absolute z-20 mt-1 w-full max-h-64 overflow-auto rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 shadow-xl hidden"></div>
          </div>
        </div>

        <!-- Conditional fields -->
        <div id="conditionalFields" class="space-y-4 hidden">
          <h3 id="extraHeader" class="font-medium">معلومات إضافية مطلوبة لبعض الحالات</h3>

          <!-- Diabetes severity (for T1DM/T2DM) -->
          <div id="extra-dm-severity" class="hidden">
            <label id="lblDmSeverity" class="block text-sm font-medium mb-1">شدة السكري (لاعتلال الشبكية)</label>
            <div class="grid gap-2 sm:grid-cols-2">
              <label class="inline-flex items-center gap-2 text-sm"><input type="radio" name="dmSeverity" value="severe" class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" /><span id="optSevere">شديد (زيارة خلال 3 أشهر)</span></label>
              <label class="inline-flex items-center gap-2 text-sm"><input type="radio" name="dmSeverity" value="moderate" class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" /><span id="optModerate">متوسط (خلال 6 أشهر)</span></label>
              <label class="inline-flex items-center gap-2 text-sm"><input type="radio" name="dmSeverity" value="mild" class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" /><span id="optMild">بسيط (خلال 9 أشهر)</span></label>
              <label class="inline-flex items-center gap-2 text-sm"><input type="radio" name="dmSeverity" value="unknown" class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" /><span id="optUnknown">لا أعرف شدة السكري (سنة واحدة)</span></label>
            </div>
          </div>

          <!-- Thyroid eye disease -->
          <div id="extra-ted" class="hidden">
            <div class="flex items-center gap-2">
              <input id="tedActive" type="checkbox" class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" />
              <label id="lblTedActive" for="tedActive" class="text-sm">نشِط حاليًا (مرض عين درقي)</label>
            </div>
            <p id="helpTed" class="text-xs text-slate-500 mt-1">نشِط: كل 3–6 أشهر. مستقر: سنوي.</p>
          </div>
        </div>

        <div class="flex flex-wrap items-center gap-3 pt-2">
          <button type="submit" id="btnCalc" class="px-5 py-2.5 rounded-xl bg-indigo-600 text-white font-medium hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">احسب الزيارة القادمة</button>
          <button type="button" id="resetBtn" class="px-4 py-2 rounded-xl border bg-white text-slate-700 hover:bg-slate-50 border-slate-300 dark:bg-slate-800 dark:text-slate-200 dark:border-slate-600 dark:hover:bg-slate-700">إعادة ضبط</button>
          <button type="button" id="printBtn" class="px-4 py-2 rounded-xl border bg-white text-slate-700 hover:bg-slate-50 border-slate-300 dark:bg-slate-800 dark:text-slate-200 dark:border-slate-600 dark:hover:bg-slate-700 ml-auto">طباعة/حفظ PDF</button>
        </div>
      </form>
    </section>

    <section id="resultsCard" class="bg-white/80 dark:bg-slate-900/70 backdrop-blur shadow-lg rounded-2xl border border-gray-200 dark:border-slate-700 p-5 md:p-6 mt-6 hidden">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
        <h2 id="resultsTitle" class="text-xl font-semibold">النتيجة</h2>
      </div>

      <div class="no-print mt-3 p-3 rounded-2xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800">
        <div id="actionsTitle" class="text-sm font-medium mb-2">أدوات النتيجة</div>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
          <button id="copyBtn" class="px-4 py-2 rounded-xl border bg-white text-slate-700 hover:bg-slate-50 border-slate-300 dark:bg-slate-800 dark:text-slate-200 dark:border-slate-600 dark:hover:bg-slate-700 w-full border-2 border-slate-400 dark:border-slate-500">Copy / Share</button>
          <button id="icsBtn" class="px-4 py-2 rounded-xl border bg-white text-slate-700 hover:bg-slate-50 border-slate-300 dark:bg-slate-800 dark:text-slate-200 dark:border-slate-600 dark:hover:bg-slate-700 w-full border-2 border-slate-400 dark:border-slate-500">Add to Calendar (.ics)</button>
        </div>
        <label class="mt-3 inline-flex items-center gap-2 text-sm">
          <input id="earliestOnly" type="checkbox" class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" />
          <span id="lblEarliestOnly">عرض الأقرب فقط</span>
        </label>
      </div>

      <p id="ruleExplain" class="mt-4 text-sm text-slate-600 dark:text-slate-300">عند تعدد الحالات نستخدم أقرب موعد آمن حسب اختيارك.</p>
      <div id="summary" class="mt-3 text-slate-700 dark:text-slate-200"></div>
      <div id="dueBanner" class="mt-3 hidden p-3 rounded-xl border text-sm"></div>
      <div id="details" class="mt-4 space-y-3"></div>
      <div id="disclaimer" class="mt-4 p-3 rounded-xl bg-amber-50 dark:bg-amber-900/30 border border-amber-200 dark:border-amber-700 text-amber-800 dark:text-amber-200 text-sm">
        تنبيه: هذه أداة تثقيفية ولا تُغني عن التقييم الطبي.
      </div>
    </section>

    <footer class="max-w-5xl mx-auto px-1 mt-10 mb-8 text-xs text-slate-500 dark:text-slate-400">
      <p id="footerText">© 2025 جميع الحقوق محفوظة لسُلطان عبد الرحمن الحسن. Ophth-Scheduler™ — يُحظر نسخ أو إعادة توزيع أو استخراج أو إجراء هندسة عكسية دون إذن.</p>
    </footer>
  </main>

  <script>
  document.addEventListener('DOMContentLoaded', function(){
    // ===== i18n =====
    const TR = {
      ar: {
        title: "حاسبة مواعيد زيارة طبيب العيون",
        subtitle: "اختر الحالات، أدخل عمرك أو فئتك العمرية وتاريخ آخر زيارة، وسنحسب أقرب موعد.",
        ageGroupToggle: "استخدام الفئة العمرية بدلاً من تاريخ الميلاد",
        ageGroup: "الفئة العمرية",
        helpAgeGroup: "اختر فقط إذا لم ترغب بإدخال تاريخ الميلاد.",
        dob: "تاريخ الميلاد",
        helpDob: "يُستخدم لحساب الفئة العمرية.",
        lastVisit: "تاريخ آخر زيارة لطبيب العيون",
        noOphthVisit: "لا توجد لدي زيارات سابقة لطبيب العيون",
        asapMsg: "في أقرب وقت ممكن من أجل سلامتك ومن حرصنا عليك.",
        helpLastVisit: "مثال: 2024-12-05. لا تقبل تاريخًا مستقبليًا.",
        errRequiredDate: "هذا الحقل إجباري. الرجاء إدخال تاريخ آخر زيارة أو اختر خيار عدم وجود زيارات.",
        errFutureDate: "لا يمكن أن يكون التاريخ في المستقبل.",
        errRequiredDob: "الرجاء إدخال تاريخ الميلاد أو اختر الفئة العمرية.",
        condHeader: "اختر الحالات/الظروف لديك",
        condHelper: "يمكنك اختيار أكثر من حالة؛ سنعرض أقرب موعد.",
        condSearchPh: "ابحث عن الحالة...",
        condClear: "مسح",
        actionsTitle: "أدوات النتيجة",
        extraHeader: "معلومات إضافية مطلوبة لبعض الحالات",
        dmSeverity: "شدة السكري (لاعتلال الشبكية)",
        dmExplain: "إذا كانت لديك سكري نوع أول أو ثاني، اختر شدة الحالة: شديد 3 أشهر، متوسط 6 أشهر، بسيط 9 أشهر، لا أعلم = سنة.",
        optSevere: "شديد (زيارة خلال 3 أشهر)",
        optModerate: "متوسط (خلال 6 أشهر)",
        optMild: "بسيط (خلال 9 أشهر)",
        optUnknown: "لا أعرف شدة السكري (سنة واحدة)",
        tedActive: "نشِط حاليًا (مرض عين درقي)",
        helpTed: "نشِط: كل 3–6 أشهر. مستقر: سنوي.",
        btnCalc: "احسب الزيارة القادمة",
        btnReset: "إعادة ضبط",
        btnPrint: "طباعة/حفظ PDF",
        resultsTitle: "النتيجة",
        lastVisitShort: "تاريخ آخر زيارة",
        age: "العمر",
        ageGroupLabel: "الفئة العمرية",
        earliest: "أقرب موعد موصى به",
        noneAuto: "لا يوجد تاريخ محدد تلقائيًا — راجع التفاصيل.",
        basis: "الأساس",
        nextVisit: "الزيارة القادمة",
        window: "نافذة المتابعة",
        notes: "ملاحظات",
        disclaimer: "تنبيه: هذه أداة تثقيفية ولا تُغني عن التقييم الطبي.",
        footer: "© 2025 جميع الحقوق محفوظة لسُلطان عبد الرحمن الحسن. Ophth-Scheduler™ — يُحظر نسخ أو إعادة توزيع أو استخراج أو إجراء هندسة عكسية دون إذن.",
        adultsEnterDOB: "للبالغين بدون عوامل خطورة: الرجاء إدخال تاريخ الميلاد أو اختيار الفئة العمرية.",
        adultsUnder40: "بدون عوامل خطورة: الفحص الشامل عند عمر 40 سنة.",
        ruleExplain: "عند تعدد الحالات نستخدم أقرب موعد آمن حسب اختيارك.",
        earliestOnly: "عرض الأقرب فقط",
        copyShare: "نسخ/مشاركة",
        addCalendar: "إضافة إلى التقويم (.ics)",
        dueNow: "مستحق الآن",
        overdueBy: (d)=>`متأخر بـ ${d} يوم`,
        dueIn: (d)=>`متبقٍ ${d} يوم`,
        contact: { summary: "تواصل", email: "البريد الإلكتروني", phone: "الهاتف" },
        conds: {
          noRiskAdults: "بالغون بدون عوامل خطورة معروفة",
          healthyChildren: "أطفال أصحاء (فحوصات نظر روتينية أولية)",
          t1dm: "السكري النوع الأول (بالغون)",
          t2dm: "السكري النوع الثاني (بالغون)",
          antiVEGF: "استخدام مضادات عامل النمو VEGF (حقن)",
          hba1cHigh: "HbA1c أعلى من الطبيعي",
          glp1: "استخدام سيماجلوتايد (أوزمبيك) أو تيرزيباتايد (مونجارُو)",
          dmPregnancy: "حمل مع سكري قائم (نوع 1 أو 2)",
          gdm: "سكري حملي",
          glauSuspect: "مشتبه ماء أزرق / ارتفاع ضغط العين",
          fhGlaucoma: "قرابة درجة أولى لمريض ماء أزرق (بدون اشتباه)",
          highMyopia: "قصر نظر شديد (≤ −6.0 D أو طول محوري > 26 مم)",
          ted: "مرض عين درقي (غريفز)"
        },
        explain: {
          ageRange: "40–54 سنة: كل 2–4 سنوات • 55–64: كل 1–3 سنوات • ≥65: كل 1–2 سنة",
          text: "لا حاجة لزيارة طبيب العيون إذا كانت فحوصات النظر الأولية طبيعية.",
          dm: "اختر شدة السكري: شديد 3 أشهر • متوسط 6 أشهر • بسيط 9 أشهر • لا أعلم: سنة.",
          pregnancyDM: "قبل الحمل والثلث الأول ثم كل ثلث؛ ما بعد الولادة حسب الطبيب.",
          gdm: "لا يلزم فحص اعتلال الشبكية أثناء الحمل؛ استأنف الجدول العمري بعد الولادة.",
          thyroidEye: "كل 3–6 أشهر أثناء النشاط؛ سنوي بعد الاستقرار/اليوثيرويد.",
          antiVEGF: "خلال العلاج النشط بمضادات VEGF، المتابعة عادةً شهرية؛ حسب تقدير الطبيب المعالج.",
          hba1c: "HbA1c أعلى من الطبيعي: متابعة سنوية من تاريخ آخر زيارة.",
          glp1: "استخدام GLP-1/GIP (أوزمبيك/مونجارو): متابعة سنوية ما لم يوجه الطبيب خلاف ذلك."
        }
      },
      en: {
        title: "Ophthalmology Visit Scheduler",
        subtitle: "Select your conditions, enter DOB or age group and last visit date, and we’ll compute the next exam.",
        ageGroupToggle: "Use age group instead of date of birth",
        ageGroup: "Age group",
        helpAgeGroup: "Use this only if you prefer not to enter DOB.",
        dob: "Date of birth",
        helpDob: "Used to determine age group.",
        lastVisit: "Last ophthalmology visit date",
        noOphthVisit: "I have no visit to the ophthalmologist",
        asapMsg: "As soon as possible for your safety and out of our concern for you.",
        helpLastVisit: "Example: 2024-12-05. Future dates are not allowed.",
        errRequiredDate: "This field is required. Enter the last visit date or check the no-visit option.",
        errFutureDate: "Date cannot be in the future.",
        errRequiredDob: "Please enter date of birth or choose an age group.",
        condHeader: "Select your conditions",
        condHelper: "You can choose multiple; we’ll suggest the earliest due date.",
        condSearchPh: "Search condition...",
        condClear: "Clear",
        actionsTitle: "Result tools",
        extraHeader: "Additional info required for some conditions",
        dmSeverity: "Diabetes severity (for retinopathy follow-up)",
        dmExplain: "If you have Type 1 or Type 2 diabetes, choose severity: Severe 3 months, Moderate 6 months, Mild 9 months, I don’t know = 1 year.",
        optSevere: "Severe (in 3 months)",
        optModerate: "Moderate (in 6 months)",
        optMild: "Mild (in 9 months)",
        optUnknown: "I don’t know (in 1 year)",
        tedActive: "Currently active (thyroid eye disease)",
        helpTed: "Active: every 3–6 months. Stable: annually.",
        btnCalc: "Calculate next visit",
        btnReset: "Reset",
        btnPrint: "Print / Save PDF",
        resultsTitle: "Result",
        lastVisitShort: "Last visit",
        age: "Age",
        ageGroupLabel: "Age group",
        earliest: "Earliest recommended",
        noneAuto: "No automatic date — see details below.",
        basis: "Basis",
        nextVisit: "Next visit",
        window: "Follow-up window",
        notes: "Notes",
        disclaimer: "Note: Educational tool; not a substitute for medical care.",
        footer: "© 2025 جميع الحقوق محفوظة لسُلطان عبد الرحمن الحسن. Ophth-Scheduler™ — يُحظر نسخ أو إعادة توزيع أو استخراج أو إجراء هندسة عكسية دون إذن.",
        adultsEnterDOB: "For adults without risk factors: enter DOB or choose an age group.",
        adultsUnder40: "Without risk factors: comprehensive eye exam at age 40.",
        ruleExplain: "If multiple conditions exist, the earliest safe interval is used.",
        earliestOnly: "Show only earliest",
        copyShare: "Copy / Share",
        addCalendar: "Add to Calendar (.ics)",
        dueNow: "Due now",
        overdueBy: (d)=>`Overdue by ${d} day${d===1?'':'s'}`,
        dueIn: (d)=>`Due in ${d} day${d===1?'':'s'}`,
        contact: { summary: "Contact", email: "Email", phone: "Phone" },
        conds: {
          noRiskAdults: "Adults without known risk factors",
          healthyChildren: "Healthy children (primary vision screening)",
          t1dm: "Type 1 diabetes (adults)",
          t2dm: "Type 2 diabetes (adults)",
          antiVEGF: "On anti-VEGF therapy (injections)",
          hba1cHigh: "HbA1c above normal",
          glp1: "Using semaglutide (Ozempic) or tirzepatide (Mounjaro)",
          dmPregnancy: "Pregnancy with pre-existing diabetes (T1/T2)",
          gdm: "Gestational diabetes",
          glauSuspect: "Glaucoma suspect / ocular hypertension",
          fhGlaucoma: "First-degree relative of a glaucoma patient (no personal suspicion)",
          highMyopia: "High myopia (≤ −6.0 D or axial length > 26 mm)",
          ted: "Thyroid eye disease (Graves)"
        },
        explain: {
          ageRange: "40–54 yrs: every 2–4 yrs • 55–64: every 1–3 yrs • ≥65: every 1–2 yrs",
          text: "No routine ophthalmology visit is needed if primary vision screening is normal.",
          dm: "Select diabetes severity: Severe 3 mo • Moderate 6 mo • Mild 9 mo • Don’t know: 1 yr.",
          pregnancyDM: "Before conception & 1st trimester; each trimester; postpartum per clinician.",
          gdm: "No retinopathy exam during pregnancy; resume age-based routine after delivery.",
          thyroidEye: "Every 3–6 months while active; annually when stable/euthyroid.",
          antiVEGF: "While on active anti-VEGF therapy, follow-up is typically monthly; per treating ophthalmologist.",
          hba1c: "HbA1c above normal: yearly follow-up from the last visit.",
          glp1: "Using GLP-1/GIP (Ozempic/Mounjaro): yearly follow-up unless advised otherwise."
        }
      }
    };

    // ===== Conditions (HCQ/Tamox removed; new ones added) =====
    const CONDITIONS = [
      { id: 'noRiskAdults', type: 'ageRange' },
      { id: 'healthyChildren', type: 'text' },
      { id: 't1dm', type: 'dm' },
      { id: 't2dm', type: 'dm' },
      { id: 'antiVEGF', type: 'antiVEGF' },
      { id: 'hba1cHigh', type: 'hba1c' },
      { id: 'glp1', type: 'glp1' },
      { id: 'dmPregnancy', type: 'pregnancyDM' },
      { id: 'gdm', type: 'gdm' },
      { id: 'glauSuspect', type: 'annual' },
      { id: 'fhGlaucoma', type: 'annual' },
      { id: 'highMyopia', type: 'annual' },
      { id: 'ted', type: 'thyroidEye' }
    ];

    // ===== Utils =====
    function addYears(d,n){const x=new Date(d);x.setFullYear(x.getFullYear()+n);return x;}
    function addMonths(d,n){const x=new Date(d);x.setMonth(x.getMonth()+n);return x;}
    function fmt(date){if(!(date instanceof Date)||isNaN(date))return'—';const dd=String(date.getDate()).padStart(2,'0');const mm=String(date.getMonth()+1).padStart(2,'0');const yy=date.getFullYear();return`${dd}/${mm}/${yy}`;}
    function calcAgeYears(dob){if(!dob)return null;const t=new Date();let a=t.getFullYear()-dob.getFullYear();const m=t.getMonth()-dob.getMonth();if(m<0||(m===0&&t.getDate()<dob.getDate()))a--;return a;}
    function daysBetween(a,b){const MS=86400000;return Math.round((a.setHours(0,0,0,0)-b.setHours(0,0,0,0))/MS);}

    // ===== Theme =====
    const THEME_KEY='oph_theme';
    function setTheme(th){const root=document.documentElement;if(th==='dark'){root.classList.add('dark');root.classList.remove('light');}else{root.classList.remove('dark');root.classList.add('light');th='light';}localStorage.setItem(THEME_KEY,th);}
    document.getElementById('theme-light').addEventListener('click',()=>setTheme('light'));
    document.getElementById('theme-dark').addEventListener('click',()=>setTheme('dark'));
    setTheme(localStorage.getItem(THEME_KEY)||'light');

    // ===== Language =====
    let currentLang='ar';
    function t(path){const obj=TR[currentLang];const val=path.split('.').reduce((o,k)=>(o||{})[k],obj);return(typeof val==='function')?val:(val||'');}
    function tp(path,...args){let cur=TR[currentLang];for(const k of path.split('.'))cur=(cur||{})[k];return typeof cur==='function'?cur(...args):cur;}
    function setLang(lang){
      currentLang=lang; document.documentElement.lang=(lang==='ar'?'ar':'en'); document.documentElement.dir=(lang==='ar'?'rtl':'ltr');
      const ids=[
        ['title','title'],['subtitle','subtitle'],['lblAgeGroupToggle','ageGroupToggle'],['lblDob','dob'],
        ['helpDob','helpDob'],['lblLastVisit','lastVisit'],['lblNoOphthVisit','noOphthVisit'],['helpLastVisit','helpLastVisit'],
        ['condHeader','condHeader'],['condHelper','condHelper'],['extraHeader','extraHeader'],['lblDmSeverity','dmSeverity'],
        ['optSevere','optSevere'],['optModerate','optModerate'],['optMild','optMild'],['optUnknown','optUnknown'],
        ['lblTedActive','tedActive'],['helpTed','helpTed'],['btnCalc','btnCalc'],['resetBtn','btnReset'],['printBtn','btnPrint'],
        ['resultsTitle','resultsTitle'],['ruleExplain','ruleExplain'],['footerText','footer'],['lblEarliestOnly','earliestOnly'],
        ['copyBtn','copyShare'],['icsBtn','addCalendar'],['lblAgeGroup','ageGroup'],['helpAgeGroup','helpAgeGroup']
      ];
      ids.forEach(([id,key])=>{const el=document.getElementById(id); if(el){ el.textContent=t(key); }});
      document.getElementById('contactSummary').firstChild.nodeValue = t('contact.summary')+' ';
      document.getElementById('contactEmailLabel').textContent = t('contact.email');
      document.getElementById('contactPhoneLabel').textContent = t('contact.phone');
      document.getElementById('condSearch').placeholder = t('condSearchPh');
      document.getElementById('clearConds').textContent = t('condClear');
      renderDropdown(document.getElementById('condSearch').value||''); renderChips(); toggleExtra();
    }
    document.getElementById('lang-ar').addEventListener('click',()=>setLang('ar'));
    document.getElementById('lang-en').addEventListener('click',()=>setLang('en'));

    // ===== Conditions multi-select =====
    const selectedIds=new Set();
    const chipsEl=document.getElementById('selectedChips');
    const searchEl=document.getElementById('condSearch');
    const dropdownEl=document.getElementById('condDropdown');
    const rootEl=document.getElementById('condMultiRoot');
    const clearBtn=document.getElementById('clearConds');

    function renderChips(){
      chipsEl.innerHTML=''; selectedIds.forEach(id=>{
        const span=document.createElement('span');
        span.className='inline-flex items-center gap-2 rounded-full px-2.5 py-1 text-xs border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800';
        span.innerHTML=`<span>${t(\`conds.${id}\`)}</span><button type="button" aria-label="remove" class="text-slate-500 hover:text-rose-600">×</button>`;
        span.querySelector('button').onclick=()=>{selectedIds.delete(id);renderChips();renderDropdown(searchEl.value);toggleExtra();};
        chipsEl.appendChild(span);
      });
      clearBtn.classList.toggle('hidden',selectedIds.size===0);
    }

    function renderDropdown(filter=''){
      const f=(filter||'').trim().toLowerCase(); dropdownEl.innerHTML='';
      CONDITIONS.filter(c=>t(\`conds.${c.id}\`).toLowerCase().includes(f)).forEach(c=>{
        const checked=selectedIds.has(c.id);
        const row=document.createElement('button'); row.type='button';
        row.className=`w-full text-right px-3 py-2 border-b last:border-b-0 border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700 ${checked?'bg-indigo-50/60 dark:bg-indigo-900/30':''}`;
        row.innerHTML=`
          <div class="flex items-start gap-2">
            <input type="checkbox" ${checked?'checked':''} class="mt-1 pointer-events-none rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" />
            <div>
              <div class="font-medium">${t(\`conds.${c.id}\`)}</div>
              <div class="text-xs text-slate-500 dark:text-slate-400">${t(\`explain.${c.type}\`)}</div>
            </div>
          </div>`;
        row.onclick=()=>{ if(checked) selectedIds.delete(c.id); else selectedIds.add(c.id); renderChips(); renderDropdown(f); toggleExtra(); };
        dropdownEl.appendChild(row);
      });
    }

    function openDropdown(){ dropdownEl.classList.remove('hidden'); }
    function closeDropdown(){ dropdownEl.classList.add('hidden'); }
    document.getElementById('condControl').addEventListener('click',()=>{ openDropdown(); searchEl.focus(); });
    searchEl.addEventListener('input',e=>{ renderDropdown(e.target.value); openDropdown(); });
    clearBtn.addEventListener('click',()=>{ selectedIds.clear(); renderChips(); renderDropdown(searchEl.value); toggleExtra(); });
    document.addEventListener('click',e=>{ if(!rootEl.contains(e.target)) closeDropdown(); });
    function getSelectedConditions(){ return CONDITIONS.filter(c=>selectedIds.has(c.id)).map(c=>({...c,label:t(\`conds.${c.id}\`)})); }

    // ===== Age group toggle =====
    const ageGroupToggle=document.getElementById('ageGroupToggle');
    ageGroupToggle.addEventListener('change',()=>{
      document.getElementById('dobWrap').classList.toggle('hidden',ageGroupToggle.checked);
      document.getElementById('ageGroupWrap').classList.toggle('hidden',!ageGroupToggle.checked);
    });

    // ===== Conditional fields visibility =====
    function sel(id){return selectedIds.has(id);}
    function toggleExtra(){
      const showDm=sel('t1dm')||sel('t2dm'); const any=showDm||sel('ted');
      document.getElementById('conditionalFields').classList.toggle('hidden',!any);
      document.getElementById('extra-dm-severity').classList.toggle('hidden',!showDm);
      document.getElementById('extra-ted').classList.toggle('hidden',!sel('ted'));
    }

    // ===== Reset / Print =====
    function clearFieldError(id){const i=document.getElementById(id);const e=document.getElementById(id+'Error');if(i&&e){e.textContent='';e.classList.add('hidden');i.classList.remove('invalid');}}
    document.getElementById('resetBtn').addEventListener('click',()=>{
      document.getElementById('schedulerForm').reset();
      selectedIds.clear(); renderChips(); renderDropdown('');
      document.getElementById('conditionalFields').classList.add('hidden');
      document.getElementById('resultsCard').classList.add('hidden');
      clearFieldError('lastVisit'); clearFieldError('dob');
    });
    document.getElementById('printBtn').addEventListener('click',()=>window.print());

    // ===== Submit =====
    function showFieldError(id,msg){const i=document.getElementById(id);const e=document.getElementById(id+'Error');if(!(i&&e))return;e.textContent=msg;e.classList.remove('hidden');i.classList.add('invalid');i.scrollIntoView({behavior:'smooth',block:'start'});setTimeout(()=>i.focus({preventScroll:true}),350);}

    const NO_VISIT_ID='noOphthVisit';

    document.getElementById('schedulerForm').addEventListener('submit', (e)=>{
      e.preventDefault();

      // If "no visit" → ASAP, ignore everything else
      const noVisit=document.getElementById(NO_VISIT_ID).checked;
      const today=new Date(); today.setHours(0,0,0,0);

      let lastVisit=null;
      if(!noVisit){
        const lastVisitStr=document.getElementById('lastVisit').value;
        if(!lastVisitStr){ showFieldError('lastVisit',t('errRequiredDate')); return; } else { clearFieldError('lastVisit'); }
        lastVisit=new Date(lastVisitStr);
        if(lastVisit>today){ showFieldError('lastVisit',t('errFutureDate')); return; } else { clearFieldError('lastVisit'); }
      }

      let ageYears=null; let ageGroupLabel='';
      if(document.getElementById('ageGroupToggle').checked){
        const g=document.getElementById('ageGroup').value;
        if(g==='u40'){ ageYears=30; ageGroupLabel=(currentLang==='ar'?'< 40':'< 40'); }
        if(g==='40-54'){ ageYears=45; ageGroupLabel='40–54'; }
        if(g==='55-64'){ ageYears=60; ageGroupLabel='55–64'; }
        if(g==='>=65'){ ageYears=70; ageGroupLabel='≥65'; }
        clearFieldError('dob');
      }else{
        const dobStr=document.getElementById('dob').value;
        if(!dobStr){ showFieldError('dob',t('errRequiredDob')); return; } else { clearFieldError('dob'); }
        const dob=new Date(dobStr); ageYears=calcAgeYears(dob);
      }

      const resultsCard=document.getElementById('resultsCard');
      const summary=document.getElementById('summary');
      const details=document.getElementById('details');
      const dueBanner=document.getElementById('dueBanner');
      resultsCard.classList.remove('hidden');

      if(noVisit){
        summary.innerHTML = `<div class="text-lg font-semibold">${t('asapMsg')}</div>`;
        dueBanner.classList.add('hidden'); details.innerHTML=''; return;
      }

      const selected=getSelectedConditions();
      const recommendations=[];

      function dmNextBySeverity(baseDate){
        const v=(document.querySelector('input[name="dmSeverity"]:checked')||{}).value||'unknown';
        if(v==='severe') return addMonths(baseDate,3);
        if(v==='moderate') return addMonths(baseDate,6);
        if(v==='mild') return addMonths(baseDate,9);
        return addYears(baseDate,1);
      }

      selected.forEach(c=>{
        switch(c.type){
          case 'annual': recommendations.push({label:c.label,nextDate:addYears(lastVisit,1),window:null,basis:(currentLang==='ar'?'فحص سنوي':'Annual')}); break;
          case 'ageRange':
            if(ageYears<40) { /* info only */ }
            else if(ageYears<=54){ recommendations.push({label:c.label,nextDate:addYears(lastVisit,2),window:[addYears(lastVisit,2),addYears(lastVisit,4)],basis:t('explain.ageRange')+' (40–54)'}); }
            else if(ageYears<=64){ recommendations.push({label:c.label,nextDate:addYears(lastVisit,1),window:[addYears(lastVisit,1),addYears(lastVisit,3)],basis:t('explain.ageRange')+' (55–64)'}); }
            else { recommendations.push({label:c.label,nextDate:addYears(lastVisit,1),window:[addYears(lastVisit,1),addYears(lastVisit,2)],basis:t('explain.ageRange')+' (≥65)'}); }
            break;
          case 'text': /* note only */ break;
          case 'dm': recommendations.push({label:c.label,nextDate:dmNextBySeverity(lastVisit),window:null,basis:t('dmExplain')}); break;
          case 'antiVEGF': recommendations.push({label:c.label,nextDate:addMonths(lastVisit,1),window:null,basis:t('explain.antiVEGF')}); break;
          case 'hba1c': recommendations.push({label:c.label,nextDate:addYears(lastVisit,1),window:null,basis:t('explain.hba1c')}); break;
          case 'glp1': recommendations.push({label:c.label,nextDate:addYears(lastVisit,1),window:null,basis:t('explain.glp1')}); break;
          case 'pregnancyDM': /* note */ break;
          case 'gdm': /* note */ break;
          case 'thyroidEye':
            const active=!!document.getElementById('tedActive')?.checked;
            if(active){const early=addMonths(lastVisit,3),late=addMonths(lastVisit,6); recommendations.push({label:c.label,nextDate:early,window:[early,late],basis:(currentLang==='ar'?'كل 3–6 أشهر أثناء النشاط':'Every 3–6 months while active')});}
            else{ recommendations.push({label:c.label,nextDate:addYears(lastVisit,1),window:null,basis:(currentLang==='ar'?'سنوي بعد الاستقرار':'Annual when stable')}); }
            break;
        }
      });

      const dated=recommendations.filter(r=>r.nextDate instanceof Date && !isNaN(r.nextDate)).sort((a,b)=>a.nextDate-b.nextDate);
      const earliest=dated[0];

      let s = `<div class="text-sm text-slate-600 dark:text-slate-300">${t('lastVisitShort')}: <span class="font-medium">${fmt(lastVisit)}</span>`;
      s += ` • ${document.getElementById('ageGroupToggle').checked?t('ageGroupLabel'):t('age')}: <span class="font-medium">${document.getElementById('ageGroupToggle').checked?ageGroupLabel:ageYears}</span>`;
      s += `</div>`;

      if(earliest){
        s += `<div class="mt-2 text-lg">${t('earliest')}: <span class="font-semibold">${fmt(earliest.nextDate)}</span></div>`;
        const today0=new Date(); today0.setHours(0,0,0,0); const diff=daysBetween(earliest.nextDate,today0);
        dueBanner.classList.remove('hidden');
        if(diff<0){ dueBanner.className='mt-3 p-3 rounded-xl border text-sm bg-rose-50 dark:bg-rose-900/30 border-rose-200 dark:border-rose-700 text-rose-800 dark:text-rose-200'; dueBanner.textContent = `متأخر بـ ${Math.abs(diff)} يوم`; }
        else if(diff===0){ dueBanner.className='mt-3 p-3 rounded-xl border text-sm bg-amber-50 dark:bg-amber-900/30 border-amber-200 dark:border-amber-700 text-amber-800 dark:text-amber-200'; dueBanner.textContent = t('dueNow'); }
        else { dueBanner.className='mt-3 p-3 rounded-xl border text-sm bg-emerald-50 dark:bg-emerald-900/30 border-emerald-200 dark:border-emerald-700 text-emerald-800 dark:text-emerald-200'; dueBanner.textContent = (currentLang==='ar'?`متبقٍ ${diff} يوم`:`Due in ${diff} days`); }
      } else {
        s += `<div class="mt-2 text-lg">${t('noneAuto')}</div>`; dueBanner.classList.add('hidden');
      }
      document.getElementById('summary').innerHTML = s;

      const earliestOnly=document.getElementById('earliestOnly').checked;
      const list = earliestOnly && earliest ? [earliest] : dated;
      const container = document.getElementById('details'); container.innerHTML='';
      list.forEach(r=>{
        const row=document.createElement('div'); row.className='p-3 border rounded-xl bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-600';
        const windowTxt=r.window?`${t('window')}: ${fmt(r.window[0])} → ${fmt(r.window[1])}`:'';
        row.innerHTML=`<div class="font-medium">${r.label}</div>
          <div class="text-sm text-slate-700 dark:text-slate-300">${t('basis')}: ${r.basis}</div>
          <div class="text-sm">${t('nextVisit')}: <span class="font-semibold">${fmt(r.nextDate)}</span>${windowTxt?`<div class='text-xs text-slate-600 dark:text-slate-400 mt-1'>${windowTxt}</div>`:''}</div>`;
        container.appendChild(row);
      });
    });

    // Copy & ICS & Earliest only
    document.getElementById('copyBtn').addEventListener('click', async ()=>{
      const txt = document.getElementById('summary').innerText.trim();
      try { await navigator.clipboard.writeText(txt); alert(currentLang==='ar'?'تم النسخ.':'Copied.'); } catch(e){}
    });
    document.getElementById('icsBtn').addEventListener('click', ()=>{
      // pick earliest date from summary (DD/MM/YYYY)
      const m=document.getElementById('summary').innerText.match(/\b(\d{2})\/(\d{2})\/(\d{4})\b/);
      if(!m) return; const [_,dd,mm,yy]=m; const ymd=`${yy}${mm}${dd}`;
      const title=currentLang==='ar'?'موعد فحص عيون موصى به':'Recommended ophthalmology visit';
      const ics=`BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//OphthoScheduler//EN
CALSCALE:GREGORIAN
BEGIN:VEVENT
UID:${Date.now()}@ophtho
DTSTAMP:${ymd}T080000Z
DTSTART;VALUE=DATE:${ymd}
SUMMARY:${title}
END:VEVENT
END:VCALENDAR`;
      const blob=new Blob([ics],{type:'text/calendar;charset=utf-8'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='ophthalmology-visit.ics'; a.click(); URL.revokeObjectURL(url);
    });
    document.getElementById('earliestOnly').addEventListener('change', ()=>{
      // Re-run submit to rebuild list
      const form=document.getElementById('schedulerForm');
      form.dispatchEvent(new Event('submit',{bubbles:true,cancelable:true}));
    });

    // Force submit handler even if native validation would block
    document.getElementById('btnCalc').addEventListener('click', function(ev){
      ev.preventDefault();
      const form=document.getElementById('schedulerForm');
      form.dispatchEvent(new Event('submit',{bubbles:true,cancelable:true}));
    });

    // Init
    function initLang(){ setLang('ar'); }
    renderDropdown(''); renderChips(); toggleExtra(); initLang();
  });
  </script>
</body>
</html>
