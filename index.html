<!doctype html>
<html lang="ar" dir="rtl" class="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ophth-Scheduler | حاسبة مواعيد العيون</title>
  <meta name="description" content="Ophthalmology visit scheduler in Arabic/English with diabetes severity, anti-VEGF, HbA1c, GLP-1, and more." />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: { extend: { fontFamily: { sans: ["Tajawal","system-ui","-apple-system","Segoe UI","Roboto","Arial"] } } }
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet" />
  <style>
    html { scroll-behavior: smooth; }
    .error-text{color:#dc2626;font-size:12px;margin-top:.25rem}
    .invalid{outline:0;box-shadow:0 0 0 4px rgba(244,63,94,.25);border-color:#ef4444}
    @media print{html{color-scheme:light}body{background:#fff!important}.no-print{display:none!important}}
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 via-cyan-50 to-indigo-50 text-slate-800 dark:from-slate-900 dark:via-slate-900 dark:to-slate-900 dark:text-slate-100">
  <header class="max-w-5xl mx-auto px-4 pt-8">
    <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
      <h1 id="title" class="text-2xl md:text-3xl font-bold">حاسبة مواعيد زيارة طبيب العيون</h1>
      <div class="flex flex-wrap items-center gap-2">
        <div class="inline-flex items-center gap-2 rounded-full px-3 py-1 text-sm border border-slate-300 bg-white dark:bg-slate-800 dark:border-slate-600">
          <button id="lang-ar" class="font-medium" type="button" onclick="setLang('ar')">العربية</button>
          <span class="mx-1">|</span>
          <button id="lang-en" type="button" onclick="setLang('en')">English</button>
        </div>
        <div class="inline-flex items-center gap-2 rounded-full px-3 py-1 text-sm border border-slate-300 bg-white dark:bg-slate-800 dark:border-slate-600" title="Theme">
          <button id="theme-light" class="font-medium" type="button" onclick="setTheme('light')">Light</button>
          <span class="mx-1">/</span>
          <button id="theme-dark" type="button" onclick="setTheme('dark')">Dark</button>
        </div>
      </div>
    </div>
    <p id="subtitle" class="mt-2 text-slate-600 dark:text-slate-300">اختر الحالات، أدخل عمرك/فئتك العمرية وتاريخ آخر زيارة، وسنحسب أقرب موعد.</p>
  </header>

  <main class="max-w-5xl mx-auto px-4 py-6">
    <!-- CONTACT BOX (auto-localizes with language toggle) -->
    <div class="mb-4">
      <details class="bg-white/80 dark:bg-slate-900/70 backdrop-blur shadow-lg rounded-2xl border border-gray-200 dark:border-slate-700 p-4 w-full sm:w-auto sm:min-w-[260px] ml-auto">
        <summary id="contactSummary" class="cursor-pointer select-none text-sm font-medium flex items-center justify-between">
          تواصل <span aria-hidden="true">▾</span>
        </summary>
        <div class="mt-3 text-sm space-y-1">
          <div><span id="contactEmailLabel">البريد الإلكتروني</span>:
            <a href="mailto:Sultan.Alhassan@hotmail.com" class="underline break-all" dir="ltr">Sultan.Alhassan@hotmail.com</a>
          </div>
          <div><span id="contactPhoneLabel">الهاتف</span>:
            <a href="tel:+966564215644" class="underline" dir="ltr">+966564215644</a>
          </div>
        </div>
      </details>
    </div>
    <!-- END CONTACT BOX -->

    <section class="bg-white/80 dark:bg-slate-900/70 backdrop-blur shadow-lg rounded-2xl border border-gray-200 dark:border-slate-700 p-5 md:p-6">
      <!-- novalidate so browser doesn't block our JS -->
      <form id="schedulerForm" class="space-y-6" novalidate>
        <div class="grid md:grid-cols-2 gap-4">
          <div class="space-y-3">
            <div class="flex items-center gap-2">
              <input id="ageGroupToggle" type="checkbox" class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" onclick="toggleAgeMode()" />
              <label for="ageGroupToggle" id="lblAgeGroupToggle" class="text-sm">استخدام الفئة العمرية بدلاً من تاريخ الميلاد</label>
            </div>
            <div id="dobWrap" class="space-y-2">
              <label for="dob" id="lblDob" class="block text-sm font-medium">تاريخ الميلاد</label>
              <input id="dob" name="dob" type="date" class="w-full rounded-2xl border-2 border-slate-300/90 bg-white dark:bg-slate-800 h-12 text-base px-4 focus:outline-none focus:ring-4 focus:ring-indigo-200 dark:focus:ring-indigo-900 focus:border-indigo-600" />
              <p id="helpDob" class="text-xs text-slate-500">يُستخدم لحساب الفئة العمرية.</p>
              <p id="dobError" class="error-text hidden" aria-live="polite"></p>
            </div>
            <div id="ageGroupWrap" class="space-y-2 hidden">
              <label for="ageGroup" id="lblAgeGroup" class="block text-sm font-medium">الفئة العمرية</label>
              <select id="ageGroup" class="w-full rounded-2xl border-2 border-slate-300/90 dark:border-slate-600 bg-white dark:bg-slate-800 h-12 text-base px-4 focus:outline-none focus:ring-4 focus:ring-indigo-200 dark:focus:ring-indigo-900 focus:border-indigo-600">
                <option value="u40">&lt; 40</option>
                <option value="40-54">40–54</option>
                <option value="55-64">55–64</option>
                <option value=">=65">≥65</option>
              </select>
              <p id="helpAgeGroup" class="text-xs text-slate-500">اختر فقط إذا لم ترغب بإدخال تاريخ الميلاد.</p>
            </div>
          </div>

          <!-- Last visit + No-visit option -->
          <div class="space-y-2" id="lastVisitWrap">
            <label for="lastVisit" class="block text-sm font-medium">
              <span id="lblLastVisit">تاريخ آخر زيارة لطبيب العيون</span> <span class="text-rose-600" aria-hidden="true">*</span>
            </label>
            <input id="lastVisit" name="lastVisit" type="date" class="w-full rounded-2xl border-2 border-slate-300/90 dark:border-slate-600 bg-white dark:bg-slate-800 h-12 text-base px-4 focus:outline-none focus:ring-4 focus:ring-indigo-200 dark:focus:ring-indigo-900 focus:border-indigo-600" aria-describedby="lastVisitHelp lastVisitError" />
            <label class="inline-flex items-center gap-2 text-sm mt-1">
              <input id="noOphthVisit" type="checkbox" class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" onclick="onNoVisitToggle()" />
              <span id="lblNoOphthVisit">لا توجد لدي زيارات سابقة لطبيب العيون</span>
            </label>
            <p id="helpLastVisit" class="text-xs text-slate-500">مثال: 2024-12-05. لا تقبل تاريخًا مستقبليًا.</p>
            <p id="lastVisitError" class="error-text hidden" aria-live="polite"></p>
          </div>
        </div>

        <!-- Conditions (simple, reliable checkboxes; HCQ/Tamox removed) -->
        <div>
          <h2 id="condHeader" class="text-lg font-semibold mb-2">اختر الحالات/الظروف لديك</h2>
          <p id="condHelper" class="text-sm text-slate-600 dark:text-slate-300 mb-3">يمكنك اختيار أكثر من حالة؛ سنعرض أقرب موعد.</p>

          <div class="grid sm:grid-cols-2 gap-2" id="condsBox">
            <label class="inline-flex items-start gap-2 text-sm"><input type="checkbox" id="c_t1dm" onclick="toggleExtra()" class="mt-1 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" /><span id="tx_t1dm">السكري النوع الأول (بالغون)</span></label>
            <label class="inline-flex items-start gap-2 text-sm"><input type="checkbox" id="c_t2dm" onclick="toggleExtra()" class="mt-1 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" /><span id="tx_t2dm">السكري النوع الثاني (بالغون)</span></label>
            <label class="inline-flex items-start gap-2 text-sm"><input type="checkbox" id="c_antiVEGF" class="mt-1 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" /><span id="tx_antiVEGF">استخدام مضادات VEGF (حقن)</span></label>
            <label class="inline-flex items-start gap-2 text-sm"><input type="checkbox" id="c_hba1c" class="mt-1 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" /><span id="tx_hba1c">HbA1c أعلى من الطبيعي</span></label>
            <label class="inline-flex items-start gap-2 text-sm"><input type="checkbox" id="c_glp1" class="mt-1 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" /><span id="tx_glp1">استخدام أوزمبيك/مونجارُو</span></label>
            <label class="inline-flex items-start gap-2 text-sm"><input type="checkbox" id="c_glauSus" class="mt-1 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" /><span id="tx_glauSus">مشتبه ماء أزرق / ارتفاع ضغط العين</span></label>
            <label class="inline-flex items-start gap-2 text-sm"><input type="checkbox" id="c_fhGlau" class="mt-1 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" /><span id="tx_fhGlau">قرابة درجة أولى لمريض ماء أزرق</span></label>
            <label class="inline-flex items-start gap-2 text-sm"><input type="checkbox" id="c_highMy" class="mt-1 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" /><span id="tx_highMy">قصر نظر شديد (≤ −6.0D أو طول محوري &gt; 26 مم)</span></label>
            <label class="inline-flex items-start gap-2 text-sm"><input type="checkbox" id="c_ted" onclick="toggleExtra()" class="mt-1 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" /><span id="tx_ted">مرض عين درقي (غريفز)</span></label>
            <label class="inline-flex items-start gap-2 text-sm"><input type="checkbox" id="c_noRisk" class="mt-1 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" /><span id="tx_noRisk">بالغون بلا عوامل خطورة</span></label>
          </div>
        </div>

        <!-- Conditional extra fields -->
        <div id="conditionalFields" class="space-y-4 hidden">
          <!-- Diabetes severity -->
          <div id="extra-dm-severity" class="hidden">
            <label id="lblDmSeverity" class="block text-sm font-medium mb-1">شدة السكري (لاعتلال الشبكية)</label>
            <div class="grid gap-2 sm:grid-cols-2">
              <label class="inline-flex items-center gap-2 text-sm"><input type="radio" name="dmSeverity" value="severe" class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" /><span id="optSevere">شديد (زيارة خلال 3 أشهر)</span></label>
              <label class="inline-flex items-center gap-2 text-sm"><input type="radio" name="dmSeverity" value="moderate" class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" /><span id="optModerate">متوسط (خلال 6 أشهر)</span></label>
              <label class="inline-flex items-center gap-2 text-sm"><input type="radio" name="dmSeverity" value="mild" class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" /><span id="optMild">بسيط (خلال 9 أشهر)</span></label>
              <label class="inline-flex items-center gap-2 text-sm"><input type="radio" name="dmSeverity" value="unknown" class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" /><span id="optUnknown">لا أعرف (زيارة خلال سنة)</span></label>
            </div>
          </div>

          <!-- Thyroid eye disease active? -->
          <div id="extra-ted" class="hidden">
            <div class="flex items-center gap-2">
              <input id="tedActive" type="checkbox" class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" />
              <label id="lblTedActive" for="tedActive" class="text-sm">نشِط حاليًا (مرض عين درقي)</label>
            </div>
            <p id="helpTed" class="text-xs text-slate-500 mt-1">نشِط: كل 3–6 أشهر. مستقر: سنوي.</p>
          </div>
        </div>

        <div class="flex flex-wrap items-center gap-3 pt-2">
          <button type="button" id="btnCalc" class="px-5 py-2.5 rounded-xl bg-indigo-600 text-white font-medium hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500" onclick="onCalc()">احسب الزيارة القادمة</button>
          <button type="button" id="resetBtn" class="px-4 py-2 rounded-xl border bg-white text-slate-700 hover:bg-slate-50 border-slate-300 dark:bg-slate-800 dark:text-slate-200 dark:border-slate-600 dark:hover:bg-slate-700" onclick="onReset()">إعادة ضبط</button>
          <button type="button" id="printBtn" class="px-4 py-2 rounded-xl border bg-white text-slate-700 hover:bg-slate-50 border-slate-300 dark:bg-slate-800 dark:text-slate-200 dark:border-slate-600 dark:hover:bg-slate-700 ml-auto" onclick="window.print()">طباعة/حفظ PDF</button>
        </div>
      </form>
    </section>

    <section id="resultsCard" class="bg-white/80 dark:bg-slate-900/70 backdrop-blur shadow-lg rounded-2xl border border-gray-200 dark:border-slate-700 p-5 md:p-6 mt-6 hidden">
      <h2 id="resultsTitle" class="text-xl font-semibold">النتيجة</h2>

      <div class="no-print mt-3 p-3 rounded-2xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800">
        <div id="actionsTitle" class="text-sm font-medium mb-2">أدوات النتيجة</div>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
          <button id="copyBtn" type="button" class="px-4 py-2 rounded-xl border bg-white text-slate-700 hover:bg-slate-50 border-slate-300 dark:bg-slate-800 dark:text-slate-200 dark:border-slate-600 dark:hover:bg-slate-700 w-full border-2 border-slate-400 dark:border-slate-500" onclick="copySummary()">Copy / Share</button>
          <button id="icsBtn" type="button" class="px-4 py-2 rounded-xl border bg-white text-slate-700 hover:bg-slate-50 border-slate-300 dark:bg-slate-800 dark:text-slate-200 dark:border-slate-600 dark:hover:bg-slate-700 w-full border-2 border-slate-400 dark:border-slate-500" onclick="downloadIcs()">Add to Calendar (.ics)</button>
        </div>
        <label class="mt-3 inline-flex items-center gap-2 text-sm">
          <input id="earliestOnly" type="checkbox" class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" onclick="rebuildAfterToggle()" />
          <span id="lblEarliestOnly">عرض الأقرب فقط</span>
        </label>
      </div>

      <p id="ruleExplain" class="mt-4 text-sm text-slate-600 dark:text-slate-300">عند تعدد الحالات نستخدم أقرب موعد آمن حسب اختيارك.</p>
      <div id="summary" class="mt-3 text-slate-700 dark:text-slate-200"></div>
      <div id="dueBanner" class="mt-3 hidden p-3 rounded-xl border text-sm"></div>
      <div id="details" class="mt-4 space-y-3"></div>
      <div id="disclaimer" class="mt-4 p-3 rounded-xl bg-amber-50 dark:bg-amber-900/30 border border-amber-200 dark:border-amber-700 text-amber-800 dark:text-amber-200 text-sm">
        تنبيه: هذه أداة تثقيفية ولا تُغني عن التقييم الطبي.
      </div>
    </section>

    <footer class="max-w-5xl mx-auto px-1 mt-10 mb-8 text-xs text-slate-500 dark:text-slate-400">
      <p id="footerText">© 2025 جميع الحقوق محفوظة لسُلطان عبد الرحمن الحسن. Ophth-Scheduler™ — يُحظر نسخ أو إعادة توزيع أو استخراج أو إجراء هندسة عكسية دون إذن.</p>
    </footer>
  </main>

  <script>
  /* ===== State & i18n ===== */
  var currentLang = 'ar';
  function setTheme(th){
    var root=document.documentElement;
    if(th==='dark'){root.classList.add('dark');root.classList.remove('light');}
    else {root.classList.remove('dark');root.classList.add('light'); th='light';}
    try{localStorage.setItem('oph_theme', th);}catch(e){}
  }
  (function(){ try{ setTheme(localStorage.getItem('oph_theme')||'light'); }catch(e){ setTheme('light'); } })();

  var TR = {
    ar: {
      title:"حاسبة مواعيد زيارة طبيب العيون",
      subtitle:"اختر الحالات، أدخل عمرك/فئتك العمرية وتاريخ آخر زيارة، وسنحسب أقرب موعد.",
      ageGroupToggle:"استخدام الفئة العمرية بدلاً من تاريخ الميلاد",
      ageGroup:"الفئة العمرية", helpAgeGroup:"اختر فقط إذا لم ترغب بإدخال تاريخ الميلاد.",
      dob:"تاريخ الميلاد", helpDob:"يُستخدم لحساب الفئة العمرية.",
      lastVisit:"تاريخ آخر زيارة لطبيب العيون",
      noOphthVisit:"لا توجد لدي زيارات سابقة لطبيب العيون",
      asapMsg:"في أقرب وقت ممكن من أجل سلامتك ومن حرصنا عليك.",
      helpLastVisit:"مثال: 2024-12-05. لا تقبل تاريخًا مستقبليًا.",
      errRequiredDate:"الرجاء إدخال تاريخ آخر زيارة أو اختر خيار عدم وجود زيارات.",
      errFutureDate:"لا يمكن أن يكون التاريخ في المستقبل.",
      errRequiredDob:"الرجاء إدخال تاريخ الميلاد أو اختر الفئة العمرية.",
      condHeader:"اختر الحالات/الظروف لديك", condHelper:"يمكنك اختيار أكثر من حالة؛ سنعرض أقرب موعد.",
      extraHeader:"معلومات إضافية مطلوبة لبعض الحالات",
      dmSeverity:"شدة السكري (لاعتلال الشبكية)",
      optSevere:"شديد (زيارة خلال 3 أشهر)", optModerate:"متوسط (خلال 6 أشهر)", optMild:"بسيط (خلال 9 أشهر)", optUnknown:"لا أعرف (سنة واحدة)",
      tedActive:"نشِط حاليًا (مرض عين درقي)", helpTed:"نشِط: كل 3–6 أشهر. مستقر: سنوي.",
      btnCalc:"احسب الزيارة القادمة", btnReset:"إعادة ضبط", btnPrint:"طباعة/حفظ PDF",
      resultsTitle:"النتيجة", lastVisitShort:"تاريخ آخر زيارة", age:"العمر", ageGroupLabel:"الفئة العمرية",
      earliest:"أقرب موعد موصى به", noneAuto:"لا يوجد تاريخ محدد تلقائيًا — راجع التفاصيل.",
      basis:"الأساس", nextVisit:"الزيارة القادمة", window:"نافذة المتابعة",
      ruleExplain:"عند تعدد الحالات نستخدم أقرب موعد آمن حسب اختيارك.",
      earliestOnly:"عرض الأقرب فقط", copyShare:"نسخ/مشاركة", addCalendar:"إضافة إلى التقويم (.ics)",
      dueNow:"مستحق الآن", overdueBy:function(d){return "متأخر بـ "+d+" يوم";}, dueIn:function(d){return "متبقٍ "+d+" يوم";},
      contact:{summary:"تواصل", email:"البريد الإلكتروني", phone:"الهاتف"},
      tx:{ t1dm:"السكري النوع الأول (بالغون)", t2dm:"السكري النوع الثاني (بالغون)",
           antiVEGF:"استخدام مضادات VEGF (حقن)", hba1c:"HbA1c أعلى من الطبيعي",
           glp1:"استخدام سيماجلوتايد (أوزمبيك) أو تيرزيباتايد (مونجارو)",
           glauSus:"مشتبه ماء أزرق / ارتفاع ضغط العين", fhGlau:"قرابة درجة أولى لمريض ماء أزرق",
           highMy:"قصر نظر شديد (≤ −6.0D أو طول محوري > 26 مم)",
           ted:"مرض عين درقي (غريفز)", noRisk:"بالغون بلا عوامل خطورة" }
    },
    en: {
      title:"Ophthalmology Visit Scheduler",
      subtitle:"Select your conditions, enter DOB or age group and last visit date, and we’ll compute the next exam.",
      ageGroupToggle:"Use age group instead of date of birth",
      ageGroup:"Age group", helpAgeGroup:"Use this only if you prefer not to enter DOB.",
      dob:"Date of birth", helpDob:"Used to determine age group.",
      lastVisit:"Last ophthalmology visit date",
      noOphthVisit:"I have no visit to the ophthalmologist",
      asapMsg:"As soon as possible for your safety and out of our concern for you.",
      helpLastVisit:"Example: 2024-12-05. Future dates are not allowed.",
      errRequiredDate:"Enter the last visit date or check the no-visit option.",
      errFutureDate:"Date cannot be in the future.",
      errRequiredDob:"Please enter date of birth or choose an age group.",
      condHeader:"Select your conditions", condHelper:"You can choose multiple; we’ll suggest the earliest date.",
      extraHeader:"Additional info required for some conditions",
      dmSeverity:"Diabetes severity (for retinopathy follow-up)",
      optSevere:"Severe (in 3 months)", optModerate:"Moderate (in 6 months)", optMild:"Mild (in 9 months)", optUnknown:"I don’t know (in 1 year)",
      tedActive:"Currently active (thyroid eye disease)", helpTed:"Active: every 3–6 months. Stable: annually.",
      btnCalc:"Calculate next visit", btnReset:"Reset", btnPrint:"Print / Save PDF",
      resultsTitle:"Result", lastVisitShort:"Last visit", age:"Age", ageGroupLabel:"Age group",
      earliest:"Earliest recommended", noneAuto:"No automatic date — see details.",
      basis:"Basis", nextVisit:"Next visit", window:"Follow-up window",
      ruleExplain:"If multiple conditions exist, we use the earliest safe interval.",
      earliestOnly:"Show only earliest", copyShare:"Copy / Share", addCalendar:"Add to Calendar (.ics)",
      dueNow:"Due now", overdueBy:function(d){return "Overdue by "+d+" day"+(d===1?"":"s");}, dueIn:function(d){return "Due in "+d+" day"+(d===1?"":"s");},
      contact:{summary:"Contact", email:"Email", phone:"Phone"},
      tx:{ t1dm:"Type 1 diabetes (adults)", t2dm:"Type 2 diabetes (adults)",
           antiVEGF:"On anti-VEGF therapy (injections)", hba1c:"HbA1c above normal",
           glp1:"Using semaglutide (Ozempic) or tirzepatide (Mounjaro)",
           glauSus:"Glaucoma suspect / ocular hypertension", fhGlau:"First-degree relative of glaucoma",
           highMy:"High myopia (≤ −6.0D or axial length > 26 mm)",
           ted:"Thyroid eye disease (Graves)", noRisk:"Adults without known risk factors" }
    }
  };

  function setLang(lang){
    currentLang = (lang==='en')?'en':'ar';
    document.documentElement.lang = currentLang;
    document.documentElement.dir  = (currentLang==='ar')?'rtl':'ltr';

    // Static text
    setText('title', TR[currentLang].title);
    setText('subtitle', TR[currentLang].subtitle);
    setText('lblAgeGroupToggle', TR[currentLang].ageGroupToggle);
    setText('lblDob', TR[currentLang].dob);
    setText('helpDob', TR[currentLang].helpDob);
    setText('lblLastVisit', TR[currentLang].lastVisit);
    setText('lblNoOphthVisit', TR[currentLang].noOphthVisit);
    setText('helpLastVisit', TR[currentLang].helpLastVisit);
    setText('condHeader', TR[currentLang].condHeader);
    setText('condHelper', TR[currentLang].condHelper);
    setText('extraHeader', TR[currentLang].extraHeader);
    setText('lblDmSeverity', TR[currentLang].dmSeverity);
    setText('optSevere', TR[currentLang].optSevere);
    setText('optModerate', TR[currentLang].optModerate);
    setText('optMild', TR[currentLang].optMild);
    setText('optUnknown', TR[currentLang].optUnknown);
    setText('lblTedActive', TR[currentLang].tedActive);
    setText('helpTed', TR[currentLang].helpTed);
    setText('btnCalc', TR[currentLang].btnCalc);
    setText('resetBtn', TR[currentLang].btnReset);
    setText('printBtn', TR[currentLang].btnPrint);
    setText('resultsTitle', TR[currentLang].resultsTitle);
    setText('ruleExplain', TR[currentLang].ruleExplain);
    setText('lblEarliestOnly', TR[currentLang].earliestOnly);
    setText('contactSummary', TR[currentLang].contact.summary);
    setText('contactEmailLabel', TR[currentLang].contact.email);
    setText('contactPhoneLabel', TR[currentLang].contact.phone);
    setText('lblAgeGroup', TR[currentLang].ageGroup);
    setText('helpAgeGroup', TR[currentLang].helpAgeGroup);

    // Condition labels
    setText('tx_t1dm', TR[currentLang].tx.t1dm);
    setText('tx_t2dm', TR[currentLang].tx.t2dm);
    setText('tx_antiVEGF', TR[currentLang].tx.antiVEGF);
    setText('tx_hba1c', TR[currentLang].tx.hba1c);
    setText('tx_glp1', TR[currentLang].tx.glp1);
    setText('tx_glauSus', TR[currentLang].tx.glauSus);
    setText('tx_fhGlau', TR[currentLang].tx.fhGlau);
    setText('tx_highMy', TR[currentLang].tx.highMy);
    setText('tx_ted', TR[currentLang].tx.ted);
    setText('tx_noRisk', TR[currentLang].tx.noRisk);
  }
  function setText(id, txt){ var el=document.getElementById(id); if(el){ el.textContent = txt; } }

  /* ===== Helpers ===== */
  function addYears(d,n){ var x=new Date(d); x.setFullYear(x.getFullYear()+n); return x; }
  function addMonths(d,n){ var x=new Date(d); x.setMonth(x.getMonth()+n); return x; }
  function fmt(date){ if(!(date instanceof Date)||isNaN(date))return'—'; var dd=('0'+date.getDate()).slice(-2); var mm=('0'+(date.getMonth()+1)).slice(-2); var yy=date.getFullYear(); return dd+'/'+mm+'/'+yy; }
  function calcAgeYears(dob){ if(!dob)return null; var t=new Date(); var a=t.getFullYear()-dob.getFullYear(); var m=t.getMonth()-dob.getMonth(); if(m<0||(m===0&&t.getDate()<dob.getDate()))a--; return a; }
  function daysBetween(a,b){ var MS=86400000; var a0=new Date(a); a0.setHours(0,0,0,0); var b0=new Date(b); b0.setHours(0,0,0,0); return Math.round((a0-b0)/MS); }

  function showFieldError(id,msg){ var i=document.getElementById(id), e=document.getElementById(id+'Error'); if(!i||!e)return; e.textContent=msg; e.classList.remove('hidden'); i.classList.add('invalid'); }
  function clearFieldError(id){ var i=document.getElementById(id), e=document.getElementById(id+'Error'); if(!i||!e)return; e.textContent=''; e.classList.add('hidden'); i.classList.remove('invalid'); }

  /* ===== UI toggles ===== */
  function toggleAgeMode(){
    var on=document.getElementById('ageGroupToggle').checked;
    document.getElementById('dobWrap').classList.toggle('hidden', on);
    document.getElementById('ageGroupWrap').classList.toggle('hidden', !on);
  }
  function onNoVisitToggle(){
    var on=document.getElementById('noOphthVisit').checked;
    var last=document.getElementById('lastVisit');
    if(on){ last.value=''; clearFieldError('lastVisit'); last.setAttribute('disabled','disabled'); }
    else { last.removeAttribute('disabled'); }
  }
  function toggleExtra(){
    var dm = document.getElementById('c_t1dm').checked || document.getElementById('c_t2dm').checked;
    var ted= document.getElementById('c_ted').checked;
    var any = dm || ted;
    document.getElementById('conditionalFields').classList.toggle('hidden', !any);
    document.getElementById('extra-dm-severity').classList.toggle('hidden', !dm);
    document.getElementById('extra-ted').classList.toggle('hidden', !ted);
  }
  function rebuildAfterToggle(){ // just re-run calc if visible
    if(!document.getElementById('resultsCard').classList.contains('hidden')) onCalc();
  }

  /* ===== Main calc ===== */
  function dmNextBySeverity(baseDate){
    var radios=document.getElementsByName('dmSeverity'); var v='unknown';
    for(var i=0;i<radios.length;i++){ if(radios[i].checked){ v=radios[i].value; break; } }
    if(v==='severe')   return addMonths(baseDate,3);
    if(v==='moderate') return addMonths(baseDate,6);
    if(v==='mild')     return addMonths(baseDate,9);
    return addYears(baseDate,1);
  }

  function onCalc(){
    var noVisit=document.getElementById('noOphthVisit').checked;
    var today=new Date(); today.setHours(0,0,0,0);
    var lastVisit=null;

    if(!noVisit){
      var lastStr=document.getElementById('lastVisit').value;
      if(!lastStr){ showFieldError('lastVisit', TR[currentLang].errRequiredDate); return false; }
      clearFieldError('lastVisit');
      lastVisit=new Date(lastStr);
      if(lastVisit>today){ showFieldError('lastVisit', TR[currentLang].errFutureDate); return false; }
      clearFieldError('lastVisit');
    }

    // Age / age group
    var ageYears=null, ageGroupLabel='';
    if(document.getElementById('ageGroupToggle').checked){
      var g=document.getElementById('ageGroup').value;
      if(g==='u40'){ ageYears=30; ageGroupLabel=(currentLang==='ar'?'< 40':'< 40'); }
      if(g==='40-54'){ ageYears=45; ageGroupLabel='40–54'; }
      if(g==='55-64'){ ageYears=60; ageGroupLabel='55–64'; }
      if(g==='>=65'){ ageYears=70; ageGroupLabel='≥65'; }
      clearFieldError('dob');
    }else{
      var dobStr=document.getElementById('dob').value;
      if(!dobStr){ showFieldError('dob', TR[currentLang].errRequiredDob); return false; }
      clearFieldError('dob'); ageYears=calcAgeYears(new Date(dobStr));
    }

    // Show results card
    document.getElementById('resultsCard').classList.remove('hidden');

    if(noVisit){
      document.getElementById('summary').innerHTML = '<div class="text-lg font-semibold">'+TR[currentLang].asapMsg+'</div>';
      document.getElementById('dueBanner').classList.add('hidden');
      document.getElementById('details').innerHTML='';
      return false;
    }

    // Build recommendations
    var recs=[];

    // Annual set: glaucoma suspect, FH glaucoma, high myopia
    function pushAnnual(label){ recs.push({label:label, next:addYears(lastVisit,1), window:null, basis:(currentLang==='ar'?'فحص سنوي':'Annual')}); }

    if(document.getElementById('c_glauSus').checked) pushAnnual(getTx('glauSus'));
    if(document.getElementById('c_fhGlau').checked)  pushAnnual(getTx('fhGlau'));
    if(document.getElementById('c_highMy').checked)  pushAnnual(getTx('highMy'));

    // Adults without risk: by age range (use lastVisit as anchor)
    if(document.getElementById('c_noRisk').checked){
      if(ageYears<40){
        // info only
      } else if(ageYears<=54){
        recs.push({label:getTx('noRisk'), next:addYears(lastVisit,2), window:[addYears(lastVisit,2), addYears(lastVisit,4)], basis:"40–54: كل 2–4 سنوات / every 2–4 yrs"});
      } else if(ageYears<=64){
        recs.push({label:getTx('noRisk'), next:addYears(lastVisit,1), window:[addYears(lastVisit,1), addYears(lastVisit,3)], basis:"55–64: كل 1–3 سنوات / every 1–3 yrs"});
      } else {
        recs.push({label:getTx('noRisk'), next:addYears(lastVisit,1), window:[addYears(lastVisit,1), addYears(lastVisit,2)], basis:"≥65: كل 1–2 سنة / every 1–2 yrs"});
      }
    }

    // Diabetes (T1/T2) → severity box controls 3/6/9/12 months
    if(document.getElementById('c_t1dm').checked) recs.push({label:getTx('t1dm'), next:dmNextBySeverity(lastVisit), window:null, basis:(currentLang==='ar'?'حسب شدة السكري':'By diabetes severity')});
    if(document.getElementById('c_t2dm').checked) recs.push({label:getTx('t2dm'), next:dmNextBySeverity(lastVisit), window:null, basis:(currentLang==='ar'?'حسب شدة السكري':'By diabetes severity')});

    // Anti-VEGF: monthly while under treatment
    if(document.getElementById('c_antiVEGF').checked) recs.push({label:getTx('antiVEGF'), next:addMonths(lastVisit,1), window:null, basis:(currentLang==='ar'?'متابعة شهرية أثناء العلاج':'Monthly during active therapy')});

    // HbA1c high → 1 year from last visit
    if(document.getElementById('c_hba1c').checked) recs.push({label:getTx('hba1c'), next:addYears(lastVisit,1), window:null, basis:(currentLang==='ar'?'ارتفاع HbA1c: سنوي':'HbA1c high: yearly')});

    // GLP-1/GIP (Ozempic/Mounjaro) → yearly unless advised otherwise
    if(document.getElementById('c_glp1').checked) recs.push({label:getTx('glp1'), next:addYears(lastVisit,1), window:null, basis:(currentLang==='ar'?'GLP-1/GIP: سنوي':'GLP-1/GIP: yearly')});

    // Thyroid eye disease
    if(document.getElementById('c_ted').checked){
      var active = document.getElementById('tedActive').checked;
      if(active){
        var early=addMonths(lastVisit,3), late=addMonths(lastVisit,6);
        recs.push({label:getTx('ted'), next:early, window:[early,late], basis:(currentLang==='ar'?'نشِط: كل 3–6 أشهر':'Active: every 3–6 months')});
      } else {
        recs.push({label:getTx('ted'), next:addYears(lastVisit,1), window:null, basis:(currentLang==='ar'?'مستقر: سنوي':'Stable: annual')});
      }
    }

    // Sort by earliest
    recs = recs.filter(function(r){return r.next instanceof Date && !isNaN(r.next);})
               .sort(function(a,b){return a.next - b.next;});
    var earliest = recs.length?recs[0]:null;

    // Summary line
    var s = '<div class="text-sm text-slate-600 dark:text-slate-300">'+TR[currentLang].lastVisitShort+': <span class="font-medium">'+fmt(lastVisit)+'</span>';
    s += ' • '+(document.getElementById('ageGroupToggle').checked?TR[currentLang].ageGroupLabel:TR[currentLang].age)+': <span class="font-medium">'+(document.getElementById('ageGroupToggle').checked?ageGroupLabel:ageYears)+'</span>';
    s += '</div>';

    var dueBanner=document.getElementById('dueBanner');
    if(earliest){
      s += '<div class="mt-2 text-lg">'+TR[currentLang].earliest+': <span class="font-semibold">'+fmt(earliest.next)+'</span></div>';
      var diff=daysBetween(earliest.next, new Date());
      dueBanner.classList.remove('hidden');
      if(diff<0){ dueBanner.className='mt-3 p-3 rounded-xl border text-sm bg-rose-50 dark:bg-rose-900/30 border-rose-200 dark:border-rose-700 text-rose-800 dark:text-rose-200'; dueBanner.textContent = (currentLang==='ar'?TR.ar.overdueBy(-diff):TR.en.overdueBy(-diff)); }
      else if(diff===0){ dueBanner.className='mt-3 p-3 rounded-xl border text-sm bg-amber-50 dark:bg-amber-900/30 border-amber-200 dark:border-amber-700 text-amber-800 dark:text-amber-200'; dueBanner.textContent = TR[currentLang].dueNow; }
      else { dueBanner.className='mt-3 p-3 rounded-xl border text-sm bg-emerald-50 dark:bg-emerald-900/30 border-emerald-200 dark:border-emerald-700 text-emerald-800 dark:text-emerald-200'; dueBanner.textContent = (currentLang==='ar'?TR.ar.dueIn(diff):TR.en.dueIn(diff)); }
    } else {
      s += '<div class="mt-2 text-lg">'+TR[currentLang].noneAuto+'</div>';
      dueBanner.classList.add('hidden');
    }
    document.getElementById('summary').innerHTML = s;

    // Details list
    var container=document.getElementById('details'); container.innerHTML='';
    var showEarliestOnly=document.getElementById('earliestOnly').checked;
    var list = (showEarliestOnly && earliest)?[earliest]:recs;
    for(var i=0;i<list.length;i++){
      var r=list[i];
      var card=document.createElement('div'); card.className='p-3 border rounded-xl bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-600';
      var windowTxt=r.window? (TR[currentLang].window+': '+fmt(r.window[0])+' → '+fmt(r.window[1])) : '';
      card.innerHTML = '<div class="font-medium">'+r.label+'</div>'
        + '<div class="text-sm text-slate-700 dark:text-slate-300">'+TR[currentLang].basis+': '+r.basis+'</div>'
        + '<div class="text-sm">'+TR[currentLang].nextVisit+': <span class="font-semibold">'+fmt(r.next)+'</span>'
        + (windowTxt?'<div class="text-xs text-slate-600 dark:text-slate-400 mt-1">'+windowTxt+'</div>':'')
        + '</div>';
      container.appendChild(card);
    }

    return false;
  }

  function onReset(){
    document.getElementById('schedulerForm').reset();
    document.getElementById('conditionalFields').classList.add('hidden');
    document.getElementById('extra-dm-severity').classList.add('hidden');
    document.getElementById('extra-ted').classList.add('hidden');
    document.getElementById('resultsCard').classList.add('hidden');
    clearFieldError('lastVisit'); clearFieldError('dob');
    // ensure lastVisit re-enabled if it was disabled by "no visit"
    document.getElementById('lastVisit').removeAttribute('disabled');
  }

  function copySummary(){
    var txt = document.getElementById('summary').innerText.trim();
    if(!txt) return;
    if(navigator.clipboard && navigator.clipboard.writeText){
      navigator.clipboard.writeText(txt).then(function(){ alert(currentLang==='ar'?'تم النسخ.':'Copied.'); });
    } else {
      // Fallback
      var ta=document.createElement('textarea'); ta.value=txt; document.body.appendChild(ta); ta.select();
      try{ document.execCommand('copy'); alert(currentLang==='ar'?'تم النسخ.':'Copied.'); }catch(e){}
      document.body.removeChild(ta);
    }
  }

  function downloadIcs(){
    // Grab first DD/MM/YYYY in summary
    var m=document.getElementById('summary').innerText.match(/\b(\d{2})\/(\d{2})\/(\d{4})\b/);
    if(!m) return; var dd=m[1], mm=m[2], yy=m[3]; var ymd=yy+mm+dd;
    var title=(currentLang==='ar')?'موعد فحص عيون موصى به':'Recommended ophthalmology visit';
    var ics="BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//OphthoScheduler//EN\nCALSCALE:GREGORIAN\nBEGIN:VEVENT\nUID:"+Date.now()+"@ophtho\nDTSTAMP:"+ymd+"T080000Z\nDTSTART;VALUE=DATE:"+ymd+"\nSUMMARY:"+title+"\nEND:VEVENT\nEND:VCALENDAR";
    var blob=new Blob([ics],{type:'text/calendar;charset=utf-8'}); var url=URL.createObjectURL(blob);
    var a=document.createElement('a'); a.href=url; a.download='ophthalmology-visit.ics'; a.click(); URL.revokeObjectURL(url);
  }

  function getTx(key){ return TR[currentLang].tx[key]; }

  // Init
  setLang('ar');
  </script>
</body>
</html>
